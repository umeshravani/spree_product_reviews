<%# Determine the correct product object from local assigns or fallback to @product %>
<% product = local_assigns[:product] || @product %>

<% if spree_current_user %>
  <% product_reviews = product.product_reviews.where(
    "approved = ? OR user_id = ?",
    true,
    spree_current_user.id
  ).order(created_at: :desc) %>
<% else %>
  <% product_reviews = product.product_reviews.where(
    approved: true
  ).order(created_at: :desc) %>
<% end %>

<div class="page-container mx-auto py-8 pb-6">
  <h1 class="text-2xl font-bold mb-6 text-center"><%= Spree.t('customer_reviews') %></h1>

  <% if product_reviews.any? %>
    <% cache ["product-reviews", product.id, product_reviews.maximum(:updated_at)] do %>
      <div class="reviews-summary mb-6">
        <div class="flex items-center mb-2">
          <div class="text-xl font-bold mr-2">
            <%= product_reviews.average(:rating).to_f.round(1) %>
          </div>
          <div class="text-yellow-400 text-xl flex gap-0.5">
            <% full_stars = product_reviews.average(:rating).to_f.floor %>
            <% half_star = (product_reviews.average(:rating).to_f - full_stars) >= 0.5 %>
            <% full_stars.times do %> <span>★</span> <% end %>
            <% if half_star %> <span>★</span> <% end %>
            <% (5 - full_stars - (half_star ? 1 : 0)).times do %>
              <span class="text-gray-300">☆</span>
            <% end %>
          </div>
          <div class="ml-2 text-gray-600">
            (<%= product_reviews.count %> <%= 'review'.pluralize(product_reviews.count) %>)
          </div>
        </div>
      </div>

      <div class="reviews-list grid gap-3">
        <% product_reviews.each do |review| %>
          <div class="review-item border p-4 border-gray-200 py-4 rounded-md">
            <div class="flex justify-between items-start mb-2">
              <div>
                <h3 class="text-lg font-medium"><%= review.title %></h3>
                <div class="text-yellow-400">
                  <%= '★' * review.rating %>
                  <%= '☆' * (5 - review.rating) %>
                </div>
              </div>
              <div class="text-sm text-gray-500">
                <%= l(review.created_at.to_date, format: :long) %>
              </div>
            </div>

            <div class="review-content my-2">
              <p><%= review.review %></p>
            </div>

            <% if review.show_identifier && review.user %>
              <div class="review-author text-sm text-gray-600" style="display: flex;align-items: flex-end;height: 35px;column-gap: 5px;">
                <%= Spree.t(:by) %> <span style="font-weight: 600;"><%= review.user.email.split('@').first %></span>
                <% if review.purchase_date.present? %>
                  <div class="inline-flex items-center gap-1 mt-1">
                    <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="h-4 w-4 text-green-600 icon icon-tabler icons-tabler-filled icon-tabler-rosette-discount-check">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M12.01 2.011a3.2 3.2 0 0 1 2.113 .797l.154 .145l.698 .698a1.2 1.2 0 0 0 .71 .341l.135 .008h1a3.2 3.2 0 0 1 3.195 3.018l.005 .182v1c0 .27 .092 .533 .258 .743l.09 .1l.697 .698a3.2 3.2 0 0 1 .147 4.382l-.145 .154l-.698 .698a1.2 1.2 0 0 0 -.341 .71l-.008 .135v1a3.2 3.2 0 0 1 -3.018 3.195l-.182 .005h-1a1.2 1.2 0 0 0 -.743 .258l-.1 .09l-.698 .697a3.2 3.2 0 0 1 -4.382 .147l-.154 -.145l-.698 -.698a1.2 1.2 0 0 0 -.71 -.341l-.135 -.008h-1a3.2 3.2 0 0 1 -3.195 -3.018l-.005 -.182v-1a1.2 1.2 0 0 0 -.258 -.743l-.09 -.1l-.697 -.698a3.2 3.2 0 0 1 -.147 -4.382l.145 -.154l.698 -.698a1.2 1.2 0 0 0 .341 -.71l.008 -.135v-1l.005 -.182a3.2 3.2 0 0 1 3.013 -3.013l.182 -.005h1a1.2 1.2 0 0 0 .743 -.258l.1 -.09l.698 -.697a3.2 3.2 0 0 1 2.269 -.944zm3.697 7.282a1 1 0 0 0 -1.414 0l-3.293 3.292l-1.293 -1.292l-.094 -.083a1 1 0 0 0 -1.32 1.497l2 2l.094 .083a1 1 0 0 0 1.32 -.083l4 -4l.083 -.094a1 1 0 0 0 -.083 -1.32z" />
                    </svg>
                    <span class="text-sm font-medium text-green-600">Verified purchase</span>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <div class="p-6 rounded-md text-center">
        <svg width="80pt" height="80pt" viewBox="0 0 512 512" version="1.1" xmlns="http://www.w3.org/2000/svg" class="mx-auto py-3">
<g id="#000000ff">
<path fill="#000000" opacity="1.00" d=" M 253.18 77.30 C 258.31 75.27 264.51 79.48 264.48 84.99 C 264.60 102.02 264.52 119.06 264.52 136.09 C 264.82 140.78 260.76 145.14 256.04 145.04 C 251.28 145.19 247.14 140.79 247.48 136.05 C 247.45 119.35 247.47 102.65 247.47 85.95 C 247.24 82.22 249.58 78.47 253.18 77.30 Z" />
<path fill="#000000" opacity="1.00" d=" M 155.34 98.52 C 159.37 96.86 164.40 98.97 166.10 102.97 C 172.57 117.18 178.86 131.47 185.30 145.70 C 187.26 149.46 189.05 154.34 185.98 158.06 C 182.50 163.12 173.85 162.31 171.51 156.59 C 164.52 141.15 157.62 125.68 150.70 110.22 C 148.46 105.91 150.75 100.10 155.34 98.52 Z" />
<path fill="#000000" opacity="1.00" d=" M 350.40 98.60 C 356.92 95.48 364.59 103.02 361.53 109.59 C 354.73 125.08 347.71 140.47 340.82 155.92 C 339.28 160.11 334.30 162.61 330.07 161.00 C 325.31 159.52 322.86 153.54 325.21 149.13 C 331.95 133.93 338.80 118.77 345.59 103.59 C 346.51 101.41 348.15 99.47 350.40 98.60 Z" />
<path fill="#000000" opacity="1.00" d=" M 237.60 173.63 C 241.04 166.39 249.03 161.63 257.05 162.15 C 264.35 162.44 271.22 167.02 274.38 173.59 C 283.93 192.96 293.36 212.40 302.90 231.78 C 323.95 234.79 345.00 237.89 366.04 241.03 C 373.70 242.01 380.59 247.56 382.88 254.98 C 385.53 262.42 383.27 271.16 377.54 276.56 C 362.33 291.53 347.13 306.53 331.85 321.43 C 335.31 342.92 339.17 364.35 342.71 385.83 C 343.60 391.57 341.96 397.65 338.21 402.11 C 333.68 407.67 326.07 410.52 319.01 409.25 C 314.61 408.59 310.85 406.06 306.96 404.08 C 289.95 395.12 273.01 386.01 255.99 377.08 C 237.31 387.02 218.60 396.90 199.91 406.81 C 193.40 410.47 184.92 410.44 178.63 406.31 C 171.59 402.01 167.81 393.22 169.39 385.14 C 173.00 363.97 176.54 342.78 180.23 321.62 C 166.58 308.00 152.73 294.56 139.01 281.00 C 136.02 277.98 132.61 275.24 130.56 271.44 C 127.06 265.17 127.22 257.08 130.95 250.95 C 134.10 245.58 139.80 241.85 145.97 241.06 C 167.01 237.95 188.07 234.91 209.11 231.77 C 218.63 212.41 228.06 192.99 237.60 173.63 M 254.36 179.58 C 253.31 180.14 252.88 181.33 252.33 182.30 C 242.48 202.48 232.61 222.65 222.72 242.81 C 221.39 245.87 218.37 247.88 215.08 248.19 C 192.73 251.48 170.35 254.69 148.01 258.04 C 145.25 258.28 144.07 262.17 146.09 263.99 C 162.43 280.26 179.01 296.29 195.35 312.55 C 198.59 315.51 197.95 320.15 197.12 323.99 C 193.47 345.33 189.80 366.66 186.23 388.01 C 185.25 391.07 189.14 393.87 191.69 391.83 C 211.99 381.18 232.16 370.31 252.47 359.69 C 256.41 357.62 260.55 359.99 263.99 361.92 C 282.73 371.90 301.50 381.83 320.25 391.78 C 322.80 393.86 326.74 391.10 325.76 388.00 C 322.01 365.37 318.01 342.77 314.28 320.13 C 313.65 317.10 314.93 314.02 317.17 311.99 C 333.26 296.15 349.40 280.34 365.47 264.47 C 367.87 262.75 367.09 258.37 364.01 258.05 C 341.34 254.52 318.60 251.43 295.93 247.95 C 292.93 247.60 290.46 245.44 289.25 242.76 C 279.25 222.38 269.31 201.98 259.31 181.61 C 258.63 179.65 256.24 178.48 254.36 179.58 Z" />
<path fill="#000000" opacity="1.00" d=" M 63.17 290.06 C 65.95 284.29 72.65 280.76 78.98 281.79 C 84.00 282.43 88.44 285.82 90.58 290.37 C 95.82 301.29 100.90 312.30 106.13 323.22 C 117.72 324.95 129.32 326.63 140.88 328.54 C 147.10 329.56 152.23 334.81 153.27 341.00 C 154.35 346.25 152.40 351.83 148.58 355.53 C 140.40 363.89 132.22 372.26 123.99 380.57 C 125.87 392.73 128.04 404.84 129.93 417.00 C 130.68 421.65 129.26 426.58 126.07 430.06 C 121.63 435.18 113.62 436.68 107.68 433.36 C 97.35 427.79 87.14 422.01 76.81 416.44 C 66.62 422.01 56.48 427.69 46.27 433.25 C 41.62 435.88 35.59 435.88 31.03 433.03 C 25.64 429.86 22.56 423.29 23.64 417.12 C 25.56 404.97 27.64 392.85 29.62 380.71 C 21.64 372.56 13.68 364.39 5.67 356.28 C 2.61 353.44 0.53 349.65 0.00 345.49 L 0.00 342.35 C 0.82 335.58 6.08 329.47 12.96 328.49 C 24.46 326.69 35.98 325.04 47.48 323.20 C 52.76 312.18 57.85 301.06 63.17 290.06 M 76.80 301.10 C 71.58 312.12 66.41 323.16 61.17 334.17 C 59.92 337.12 57.06 339.14 53.89 339.48 C 42.06 341.33 30.23 343.13 18.39 344.86 C 27.08 353.74 35.83 362.57 44.49 371.49 C 46.78 373.65 47.68 376.94 47.01 380.00 C 45.03 392.22 42.98 404.43 41.02 416.66 C 51.72 410.86 62.33 404.89 73.04 399.12 C 76.44 397.20 80.36 398.67 83.40 400.57 C 93.12 405.95 102.87 411.27 112.59 416.65 C 110.56 404.09 108.40 391.55 106.46 378.99 C 105.88 375.83 107.52 372.84 109.78 370.77 C 118.27 362.17 126.72 353.53 135.18 344.89 C 124.09 343.21 113.02 341.45 101.93 339.84 C 98.19 339.57 94.10 338.17 92.56 334.42 C 87.25 323.34 82.09 312.19 76.80 301.10 Z" />
<path fill="#000000" opacity="1.00" d=" M 421.41 290.37 C 424.08 284.53 430.69 280.84 437.06 281.74 C 442.36 282.30 447.02 285.94 449.18 290.76 C 454.32 301.56 459.37 312.41 464.52 323.21 C 476.29 325.02 488.10 326.62 499.83 328.66 C 506.49 329.93 511.34 336.06 512.00 342.67 L 512.00 345.10 C 511.54 349.41 509.41 353.35 506.26 356.29 C 498.28 364.40 490.32 372.52 482.36 380.65 C 484.34 392.82 486.44 404.98 488.35 417.16 C 489.36 423.29 486.31 429.79 480.97 432.95 C 476.41 435.79 470.37 435.83 465.72 433.18 C 455.52 427.64 445.41 421.97 435.21 416.44 C 425.15 421.97 415.10 427.53 405.04 433.06 C 400.84 435.49 395.52 435.96 391.08 433.90 C 384.72 431.14 380.79 423.85 382.05 417.00 C 383.98 404.91 386.03 392.83 388.02 380.75 C 379.69 372.12 371.22 363.63 362.88 355.01 C 359.33 351.38 357.68 345.99 358.71 341.00 C 359.77 334.81 364.90 329.56 371.12 328.54 C 382.70 326.73 394.30 325.05 405.87 323.21 C 411.08 312.28 416.18 301.29 421.41 290.37 M 419.43 334.42 C 418.22 337.05 415.71 338.96 412.85 339.37 C 400.86 341.33 388.83 343.02 376.83 344.90 C 385.44 353.72 394.11 362.48 402.71 371.30 C 405.03 373.45 406.10 376.72 405.42 379.83 C 403.44 392.11 401.39 404.38 399.40 416.66 C 410.03 410.89 420.59 404.99 431.22 399.22 C 434.07 397.60 437.60 398.11 440.31 399.77 C 450.54 405.39 460.77 411.01 470.98 416.65 C 468.99 404.43 466.96 392.21 464.98 379.99 C 464.28 376.94 465.20 373.67 467.49 371.52 C 476.16 362.63 484.90 353.80 493.56 344.90 C 481.53 343.02 469.48 341.23 457.46 339.36 C 454.54 338.93 452.05 336.92 450.87 334.24 C 445.61 323.22 440.45 312.15 435.22 301.12 C 429.88 312.19 424.75 323.35 419.43 334.42 Z" />
</g>
</svg>
      <div class="text-center text-gray-500 mt-6">
        <p class="text-lg font-semibold"><%= Spree.t('no_reviews_yet') %></p>
        <p class="mt-1 text-blue-600 text-sm"><%= Spree.t('be_the_first_to_write_a_review') %></p>
      </div>
    </div>
  <% end %>
</div>
