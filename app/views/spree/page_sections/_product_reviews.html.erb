<%# Determine the correct product object from local assigns or fallback to @product %>
<% product = local_assigns[:product] || @product %>
<% section ||= local_assigns[:section] %>
<% badge_color = section&.preferred_verified_badge_color || '#00a63e' %>

<% if spree_current_user %>
  <% product_reviews = product.product_reviews.where("approved = ? OR user_id = ?", true, spree_current_user.id).order(created_at: :desc) %>
<% else %>
  <% product_reviews = product.product_reviews.where(approved: true).order(created_at: :desc) %>
<% end %>

<div class="page-container mx-auto py-8 pb-6">
  <h1 class="text-2xl font-bold mb-6 text-center"><%= Spree.t('customer_reviews') %></h1>

  <% if product_reviews.any? %>
    <% cache ["product-reviews", product.id, product_reviews.maximum(:updated_at)] do %>
      <div class="reviews-summary mb-6">
        <div class="flex items-center mb-2">
          <div class="text-xl font-bold mr-2">
            <%= product_reviews.average(:rating).to_f.round(1) %>
          </div>
            <%
             star_color = section&.preferred_rating_color || '#FFA500'
             star_size = section&.preferred_review_font_size || 14
            %>
            <div class="flex gap-0.5" style="color:<%= star_color %>; font-size:<%= star_size %>px;">
            <% full_stars = product_reviews.average(:rating).to_f.floor %>
            <% half_star = (product_reviews.average(:rating).to_f - full_stars) >= 0.5 %>
            <% full_stars.times do %> <span>★</span> <% end %>
            <% if half_star %> <span>★</span> <% end %>
            <% (5 - full_stars - (half_star ? 1 : 0)).times do %>
              <span class="text-gray-300">☆</span>
            <% end %>
          </div>
          <div class="ml-2 text-gray-600">
            (<%= product_reviews.count %> <%= 'review'.pluralize(product_reviews.count) %>)
          </div>
        </div>
      </div>

      <div class="reviews-list grid gap-3">
        <% product_reviews.each do |review| %>
          <div class="review-item border p-4 border-gray-200 py-4 rounded-md">
            <div class="flex justify-between items-start mb-2">
              <div>
                <h3 class="font-medium" style="font-size:<%= section&.preferred_title_font_size || 18 %>px;"><%= review.title %></h3>
                <%
                review_star_color = section&.preferred_review_star_color || '#FFA500'
                %>
                <div style="color:<%= review_star_color %>;">
                  <%= '★' * review.rating %>
                  <%= '☆' * (5 - review.rating) %>
                </div>
              </div>
              <div class="text-sm text-gray-500">
                <%= l(review.created_at.to_date, format: :long) %>
              </div>
            </div>

            <div
             class="review-content my-2"
             style="font-size:<%= section&.preferred_review_font_size || 14 %>px;">
             <p><%= review.review %></p>
            </div>

            <%= render 'spree/product_reviews/images', review: review, section: section %>
            
            <% if review.show_identifier && review.user %>
              <div class="review-author text-sm text-gray-600" style="display: flex;align-items: flex-end;height: 35px;column-gap: 5px;">
                <%= Spree.t(:by) %> <span style="font-weight: 600;"><%= review.user.email.split('@').first %></span>
                <% if review.purchase_date.present? %>
                  <div class="inline-flex items-center gap-1 mt-1" style="color:<%= badge_color %>;">
                    <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="h-4 w-4 text-green-600 icon icon-tabler icons-tabler-filled icon-tabler-rosette-discount-check" >
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M12.01 2.011a3.2 3.2 0 0 1 2.113 .797l.154 .145l.698 .698a1.2 1.2 0 0 0 .71 .341l.135 .008h1a3.2 3.2 0 0 1 3.195 3.018l.005 .182v1c0 .27 .092 .533 .258 .743l.09 .1l.697 .698a3.2 3.2 0 0 1 .147 4.382l-.145 .154l-.698 .698a1.2 1.2 0 0 0 -.341 .71l-.008 .135v1a3.2 3.2 0 0 1 -3.018 3.195l-.182 .005h-1a1.2 1.2 0 0 0 -.743 .258l-.1 .09l-.698 .697a3.2 3.2 0 0 1 -4.382 .147l-.154 -.145l-.698 -.698a1.2 1.2 0 0 0 -.71 -.341l-.135 -.008h-1a3.2 3.2 0 0 1 -3.195 -3.018l-.005 -.182v-1a1.2 1.2 0 0 0 -.258 -.743l-.09 -.1l-.697 -.698a3.2 3.2 0 0 1 -.147 -4.382l.145 -.154l.698 -.698a1.2 1.2 0 0 0 .341 -.71l.008 -.135v-1l.005 -.182a3.2 3.2 0 0 1 3.013 -3.013l.182 -.005h1a1.2 1.2 0 0 0 .743 -.258l.1 -.09l.698 -.697a3.2 3.2 0 0 1 2.269 -.944zm3.697 7.282a1 1 0 0 0 -1.414 0l-3.293 3.292l-1.293 -1.292l-.094 -.083a1 1 0 0 0 -1.32 1.497l2 2l.094 .083a1 1 0 0 0 1.32 -.083l4 -4l.083 -.094a1 1 0 0 0 -.083 -1.32z" />
                    </svg>
                    <span class="text-sm font-medium">Verified purchase</span>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <div class="p-6 rounded-md text-center">
        <svg  width="80pt" height="80pt" id="Flat" viewBox="0 0 62 62" xmlns="http://www.w3.org/2000/svg"  class="mx-auto py-3"><path d="m16 26c0 12.15 9.85 22 22 22 2.23 0 4.38-.33 6.41-.95.73.59 1.6 1.15 2.61 1.6 3.7 1.66 7.04.95 8.04.7-1.1-1.13-2.67-3.04-3.79-5.8 5.3-4.01 8.73-10.38 8.73-17.55 0-12.15-9.85-22-22-22s-22 9.85-22 22z" fill="#b8c3d5"/><path d="m50 24h-24c-.55 0-1-.45-1-1s.45-1 1-1h24c.55 0 1 .45 1 1s-.45 1-1 1z" fill="#325068"/><path d="m50 18h-24c-.55 0-1-.45-1-1s.45-1 1-1h24c.55 0 1 .45 1 1s-.45 1-1 1z" fill="#325068"/><path d="m50 30h-24c-.55 0-1-.45-1-1s.45-1 1-1h24c.55 0 1 .45 1 1s-.45 1-1 1z" fill="#325068"/><path d="m50 36h-24c-.55 0-1-.45-1-1s.45-1 1-1h24c.55 0 1 .45 1 1s-.45 1-1 1z" fill="#325068"/><path d="m48 34c0 12.15-9.85 22-22 22-2.23 0-4.38-.33-6.41-.95-.73.59-1.6 1.15-2.61 1.6-3.7 1.66-7.04.95-8.04.7 1.1-1.13 2.67-3.04 3.79-5.8-5.3-4.01-8.73-10.38-8.73-17.55 0-12.15 9.85-22 22-22s22 9.85 22 22z" fill="#d3dce5"/><g fill="#536882"><path d="m19 32.78c-.26 0-.51-.1-.71-.29-.39-.39-.39-1.02 0-1.41l3.66-3.66c.39-.39 1.02-.39 1.41 0s.39 1.02 0 1.41l-3.66 3.66c-.2.2-.45.29-.71.29z"/><path d="m22.66 32.78c-.26 0-.51-.1-.71-.29l-3.66-3.66c-.39-.39-.39-1.02 0-1.41s1.02-.39 1.41 0l3.66 3.66c.39.39.39 1.02 0 1.41-.2.2-.45.29-.71.29z"/><path d="m29.34 32.78c-.26 0-.51-.1-.71-.29-.39-.39-.39-1.02 0-1.41l3.66-3.66c.39-.39 1.02-.39 1.41 0s.39 1.02 0 1.41l-3.66 3.66c-.2.2-.45.29-.71.29z"/><path d="m33 32.78c-.26 0-.51-.1-.71-.29l-3.66-3.66c-.39-.39-.39-1.02 0-1.41s1.02-.39 1.41 0l3.66 3.66c.39.39.39 1.02 0 1.41-.2.2-.45.29-.71.29z"/><path d="m32.47 42.59c-.36 0-.7-.19-.88-.53-1.1-2.07-3.24-3.35-5.58-3.35s-4.48 1.28-5.58 3.35c-.26.49-.87.67-1.35.41-.49-.26-.67-.87-.41-1.35 1.45-2.72 4.27-4.41 7.35-4.41s5.9 1.69 7.35 4.41c.26.49.08 1.09-.41 1.35-.15.08-.31.12-.47.12z"/></g></svg>
      <div class="text-center text-gray-500 mt-6">
        <p class="text-lg font-semibold"><%= Spree.t('no_reviews_yet') %></p>
        <p class="mt-1 text-blue-600 text-sm"><%= Spree.t('be_the_first_to_write_a_review') %></p>
      </div>
    </div>
  <% end %>
</div>