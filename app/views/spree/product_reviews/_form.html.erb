<% section ||= local_assigns[:section] || @page_section %>

<script>
  const MAX_FILES = <%= section&.preferred_max_images_upload || 5 %>;
  const MAX_FILE_SIZE = (<%= section&.preferred_max_image_size_mb || 5 %>) * 1024 * 1024;
  const THUMB_SIZE = <%= section&.preferred_thumbnail_size || 72 %>;
</script>

<div class="review-form-container mb-8 p-4 border border-gray-200 rounded-md shadow-sm bg-white">
  <%= form_for [:product, product_review], url: spree.product_product_reviews_path(product) do |f| %>
    <% if product_review.errors.any? %>
      <div class="error-messages bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        <h2 class="font-bold mb-2"><%= pluralize(product_review.errors.count, "error") %> prohibited this review from being saved:</h2>
        <ul class="list-disc list-inside">
          <% product_review.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

<style>
  .rating-group {
    display: inline-flex;
  }
  
  .rating__icon {
    pointer-events: none;
  }
  
  .rating__input {
    position: absolute !important;
    left: -9999px !important;
  }
  
  .rating__input--none {
    display: none;
  }
  
  .rating__label {
    cursor: pointer;
    padding: 0 0.1em;
    font-size: 2rem;
  }
  
  .rating__icon--star {
    color: orange;
  }
  
  .rating__input:checked ~ .rating__label .rating__icon--star {
    color: #ddd;
  }
  
  .rating-group:hover .rating__label .rating__icon--star {
    color: orange;
  }
  
  .rating__input:hover ~ .rating__label .rating__icon--star {
    color: #ddd;
  }
</style>

<div class="form-group mb-4">
  <%= f.label :rating, Spree.t("product_review_rating"), class: "block mb-2 font-medium text-gray-700" %>
  <div class="rating-group">
    <%# Hidden input to ensure no default selection - user must choose a rating %>
    <input class="rating__input rating__input--none" disabled checked name="<%= f.object_name %>[rating]" id="<%= f.object_name %>_rating_none" value="0" type="radio">
    
    <% (1..5).each do |i| %>
      <label aria-label="<%= i %> <%= 'star'.pluralize(i) %>" class="rating__label" for="<%= f.object_name %>_rating_<%= i %>">
        <span class="rating__icon rating__icon--star">★</span>
      </label>
      <%= f.radio_button :rating, i, id: "#{f.object_name}_rating_#{i}", required: true, class: "rating__input" %>
    <% end %>
  </div>
</div>

    <div class="form-group mb-4">
      <%= f.label :title, Spree.t("review_title"), class: "block mb-2 font-medium" %>
      <%= f.text_field :title, required: true, class: "focus:border-primary focus:ring-primary text-base bg-accent rounded-md border-accent py-2 px-4 w-full" %>
    </div>

    <div class="form-group mb-4">
      <%= f.label :review, Spree.t("page_blocks.product_review_form.placeholder_default"), class: "block mb-2 font-medium" %>
      <%= f.text_area :review, required: true, class: "focus:border-primary focus:ring-primary text-base bg-accent rounded-md border-accent py-2 px-4 w-full", rows: 4, placeholder: block.preferred_placeholder %>
    </div>

    <div class="form-group mb-4">
  <%= f.label :images, "Upload images (optional)", class: "block mb-2 font-medium text-gray-700" %>

  <%= f.file_field :images,
        multiple: true,
        accept: "image/*",
        direct_upload: true,
        class: "hidden",
        id: "review-image-upload" %>

        <label
        for="review-image-upload"
        class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium
               border border-gray-300 rounded-md cursor-pointer
               bg-white text-gray-700
               hover:bg-gray-50 hover:text-gray-900
               transition select-none">
      
        <!-- Upload icon -->
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 16 16"
          class="w-4 h-4 flex-shrink-0"
          fill="currentColor"
          aria-hidden="true">
          <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
          <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
        </svg>
      
        <!-- Text -->
        <span>Upload images</span>
      </label>
      
  <p class="mt-1 text-xs text-gray-400">
    Max <%= section&.preferred_max_images_upload || 5 %> images · JPG / PNG / GIF · Max <%= section&.preferred_max_image_size_mb || 5 %>MB each
  </p>

  <!-- Validation errors -->
  <div id="review-image-errors"
       class="hidden mt-2 text-sm text-red-600 bg-red-50 border border-red-200 rounded px-3 py-2">
  </div>

  <!-- Preview grid -->
  <div id="review-image-preview"
       class="mt-3 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
  </div>

  <!-- Upload progress -->
  <div id="review-upload-progress" class="hidden mt-3">
    <div class="h-1.5 w-full bg-gray-200 rounded">
      <div id="review-upload-bar"
           class="h-1.5 bg-primary-600 rounded transition-all"
           style="width:0%">
      </div>
    </div>
    <p class="text-xs text-gray-500 mt-1">Uploading images…</p>
  </div>
</div>

    <div class="form-group mb-4">
      <div class="flex items-center">
        <%= f.check_box :show_identifier, class: "mr-2" %>
        <%= f.label :show_identifier, "Show my name in the review", class: "text-sm text-gray-600" %>
      </div>
    </div>

    <% button_class = "btn-primary" %>
    <% button_class = "btn-secondary" if block.preferred_button_style == "secondary" %>
    <%= f.submit block.preferred_button_text, class: "#{button_class} py-2 px-6 rounded-md text-white font-medium" %>
  <% end %>
</div>
<script>
(() => {
  const MAX_FILES = <%= section&.preferred_max_images_upload || 5 %>
  const MAX_FILE_SIZE = (<%= section&.preferred_max_image_size_mb || 5 %>) * 1024 * 1024

  const input = document.getElementById("review-image-upload")
  const preview = document.getElementById("review-image-preview")
  const errors = document.getElementById("review-image-errors")
  const progressWrapper = document.getElementById("review-upload-progress")
  const progressBar = document.getElementById("review-upload-bar")

  if (!input) return

  let filesStore = []

  function showError(message) {
    errors.textContent = message
    errors.classList.remove("hidden")
  }

  function clearError() {
    errors.textContent = ""
    errors.classList.add("hidden")
  }

  function syncInputFiles() {
    const dt = new DataTransfer()
    filesStore.forEach(f => dt.items.add(f))
    input.files = dt.files
  }

  function renderPreviews() {
  preview.innerHTML = ""

  filesStore.forEach((file, index) => {
    const wrapper = document.createElement("div")
    wrapper.className =
      "relative group overflow-hidden h-24 " +
      "flex items-center justify-center rounded border bg-gray-100"

    const img = document.createElement("img")
    img.src = URL.createObjectURL(file)
    img.className =
       "w-full h-full object-cover"
    img.loading = "lazy"

    const removeBtn = document.createElement("button")
removeBtn.type = "button"
removeBtn.innerHTML = "&times;"

removeBtn.className =
  "absolute top-1 right-1 z-50 pointer-events-auto " +
  "w-8 h-8 flex items-center justify-center " +
  "rounded-full text-gray-900 shadow-md " +
  "hover:bg-white transition"

removeBtn.style.background = "rgba(255,255,255,0.45)"
removeBtn.style.backdropFilter = "blur(8px)"
removeBtn.style.webkitBackdropFilter = "blur(8px)"

    removeBtn.addEventListener("click", () => {
      filesStore.splice(index, 1)
      syncInputFiles()
      renderPreviews()
    })

    wrapper.appendChild(img)
    wrapper.appendChild(removeBtn)
    preview.appendChild(wrapper)
  })
}

  input.addEventListener("change", () => {
    clearError()

    const newFiles = Array.from(input.files)

    if (filesStore.length + newFiles.length > MAX_FILES) {
      showError(`You can upload a maximum of ${MAX_FILES} images.`)
      input.value = ""
      return
    }

    for (const file of newFiles) {
      if (file.size > MAX_FILE_SIZE) {
        showError(`"${file.name}" exceeds 5MB.`)
        input.value = ""
        return
      }
    }

    filesStore = filesStore.concat(newFiles)
    syncInputFiles()
    renderPreviews()
  })

  /* ActiveStorage progress */
  document.addEventListener("direct-upload:initialize", () => {
    progressWrapper.classList.remove("hidden")
    progressBar.style.width = "0%"
  })

  document.addEventListener("direct-upload:progress", e => {
    progressBar.style.width = `${e.detail.progress}%`
  })

  document.addEventListener("direct-upload:end", () => {
    progressBar.style.width = "100%"
    setTimeout(() => {
      progressWrapper.classList.add("hidden")
      progressBar.style.width = "0%"
    }, 400)
  })
})()
</script>
